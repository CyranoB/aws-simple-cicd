# Administrator Guide

Create a [project-config.json](../project-config.sample.json) file in the root of the Simple-CICD project. There is a sample *project-config.sample.json* file provided

- [Configure Accounts](#account-definition)
- [Configure Naming](#naming-definition)
- [Configure Pipelines](#pipeline-definition)
- [Deploy Pipelines](#build-and-deploy-the-project)

## Account definition

Add the account Ids of the target accounts to the project-config.json file. The account Id will be passed to the deployment stage as an environment variable, thus making it available to your deployment script for the entire duration of the stage.

```text
{
  dev: string,
  test: string,
  prod: string
}
```

### Account sample

```json
{
  "dev": "123456789000",
  "test": "123456789001",
  "prod": "123456789002"
}
```

### Deploy cross-account IAM role

The pipelines will be deployed and executed in the Shared Services account. The pipeline will need to assume an IAM role in the target (dev, test and prod) accounts in order to provision resources.

If the AWS accounts are generated using [AWS Landing Zone](https://aws.amazon.com/solutions/implementations/aws-landing-zone/) or [Control Tower](https://aws.amazon.com/controltower/), then use the cross-account role generated by those service and skip this step.

A sample IAM role and profile is provided in this project if this does not already exist.. Modify [deployment-role.yaml](../cross-account/deployment-role.yaml) based on your requirements and deploy it using the following commands. This role will need to be deployed to each target AWS account.

```bash
cd cross-account

aws cloudformation deploy --template-file cross-account/deployment-role.yaml --stack-name cicd-iam-stack --capabilities CAPABILITY_NAMED_IAM
```

The name of the role in the sample provided is *deployment-role*. Once the IAM role has been deployed, the Simple-CICD project needs to be configured to use it. Update *ROLE_NAME* in [assume-cross-account-role.env](../scripts/assume-cross-account-role.env)

## Naming definition

All the AWS resources provisioned by this project will follow a standard naming convention. This can be configured as desired.

```text
{
  company: string,
  dept: string,
  project: string
}
```

### Naming sample

The following sample will generate resources prefixed with *acme-markets-roadrunner*

```json
{
  "company": "acme",
  "dept": "markets",
  "project":  "roadrunner"
}
```

## Pipeline definition

- The pipeline name and branch are concatenated to create a unique pipeline per branch.
- The sample provides a single TriggerType - CodeCommit. This can be extended to add Github, BitBucket etc.
- An SNS Topic is generated for the pipeline. Subscribers receive notifications on status of each pipeline stage. Emails are sent by a Lambda function.
- A Parameter Store parameter is generated which stores the semantic version and automatically increments (uses python semver library) on every successful build.
- A Cron parameter can be set to trigger the pipeline on a schedule managed by CloudWatch.

```text
{
  pipelineName: string,
  ccRepoName: string,
  branch: string,
  type: TriggerType,
  cron: string
}
```

### Pipeline sample

The following sample will generate a pipeline called *acme-markets-roadrunner-rocket-powered-skates-master*

```json
{
  "pipelineName": "rocket-powered-skates",
  "ccRepoName": "rocket-powered-skates",
  "branch": "master",
  "type": "CodeCommit",
  "cron": ""
}
```

## Build and deploy the project

If you have not installed AWS CDK already please refer to the [pre-requisites](./prereq.md)

```bash
npm install

npm run build

cdk bootstrap --profile <shared services account profile>

cdk deploy --profile <shared services account profile>
```
